{{#> body }}
<script>
  const round = (value, digits) =>Number(value.toFixed(digits))
  function computeSplit(){
   const DECIMALS = 2
   const checked = document.querySelectorAll('input[data-included]:checked')
   const total = Number(document.querySelector('input[name=amount]').value) ?? 0 
   const amount = checked.length === 0 ? 0 : round(total / checked.length, DECIMALS)
   let remaining = round(total - amount * checked.length, DECIMALS) // remaining cents lots in rounding
   
   document.querySelectorAll('input[data-included]').forEach(el => {
    const participant = el.attributes['data-included'].value
    const ouput = el.nextElementSibling.nextElementSibling.nextElementSibling
    if(el.checked){
      if(remaining) {
        ouput.value = round(amount+ remaining, DECIMALS)
        remaining = 0
      } else ouput.value = amount
    } else ouput.value = 0 
   })
  }
  function deleteLine(){

    console.log(event) ; 
    const willDelete = confirm('Are you sure you want to delete?') 
    if(willDelete) {
       const form = event.target.closest('form')
       form.action = form.action +'/delete'
    }
    else event.preventDefault()
  }
</script>

<h1>{{project.name}}</h1>
<a href="/project/{{project.id}}" class="link">Back</a>
<form class="grid" method="post" action="">
  <input type="hidden" name="project_id" value="{{project.id}}" />
  <input type="hidden" name="id" value="{{line.id}}" />
  <label class="form-control">
    <span class="label label-text">Title</span>
    <input name="name" class="input input-bordered" value="{{line.name}}" autofocus="" />
  </label>
  <label class="form-control">
    <span class="label label-text">Amount</span>
    <div class="flex gap-2">
      <input name="amount" value="{{default line.amount 0}}"  class="input input-bordered grow" inputmode="decimal" pattern="[0-9.]*" type="text" oninput="computeSplit()"  />
      <select name="currency" class="select select-bordered">
        {{#each currencies}}
        <option value="{{this}}"  {{#ifEq this ../line.currency}}selected=""{{/ifEq}}>{{this}}</option>
        {{/each}}
      </select>
    </div>
  </label>
  <label class="form-control">
    <span class="label label-text">Date</span>
    <input type="date" name="created_at" value="{{line.created_at}}" class="input input-bordered" />
  </label>
  <label class="form-control">
    <span class="label label-text">Paid by</span>
    <select  name="paid"  class="select select-bordered">
      {{#each project.participants}}
      <option value="{{this}}" {{#ifEq this ../line.paid}}selected=""{{/ifEq}}>{{this}}</option>
      {{/each}}
    </select>
  </label>
  <ul class="grid gap-4 mt-4" x-data="{ split: {{default line.split "[]"}}  }">
    {{#each project.participants}}
    <li class="flex items-center gap-4" x-data="{ splitLine: split.find(s => s.participant === '{{this}}') }" >
      <input id="part-{{@index}}" data-included="{{this}}" :checked="splitLine ==null || splitLine.amount > 0" type="checkbox" onclick="computeSplit()" class="checkbox"/>
      <label for="part-{{@index}}" class="flex items-center gap-4">
        {{this}}
      </label>
      <input type="hidden" name="split[{{@index}}][participant]" value="{{this}}"/>
      <input name="split[{{@index}}][amount]" :value="splitLine.amount" class="input input-bordered w-full" inputmode="numeric" pattern="[0-9.]*" type="text"/>
      <span>{{../line.currency}}</span>
    </li>
    {{/each}}
  </ul>
  <div class="mt-8 flex justify-start gap-8 flex-row-reverse">
    <button class="btn btn-primary">Save</button>
    <button class="btn btn-warning" onclick="deleteLine(event)">Delete</button>
  </div>
</form>
{{/body}}